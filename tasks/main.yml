---
- name: Install dependencies
  ansible.builtin.apt:
    name:
      - python3-pip
    state: present
    update_cache: true
    cache_valid_time: "{{ awx_cache_valid_time }}"
  tags:
    - awx
    - awx.dependencies

- name: Install ansible dependencies
  ansible.builtin.pip:
    name:
      - kubernetes
      - openshift
      - pyyaml
  tags:
    - awx
    - awx.dependencies

- name: Create dir for awx operator config files
  ansible.builtin.file:
    path: "{{ awx_operator_src_dir }}"
    state: directory
    owner: "{{ awx_kubectl_user }}"
    group: "{{ awx_kubectl_user }}"
    mode: '0755'
  become: true
  tags:
    - awx
    - awx.operator

- name: Install kustomize
  ansible.builtin.shell: curl -s "https://raw.githubusercontent.com/kubernetes-sigs/kustomize/master/hack/install_kustomize.sh"  | bash
  args:
    chdir: "{{ awx_operator_src_dir }}"
  become: true
  become_user: 'root'
  register: kustomize_install
  changed_when: "'installed' in kustomize_install.stdout"
  failed_when: false
  tags:
    - awx
    - awx.dependencies

- name: Create kustomize config
  ansible.builtin.template:
    src: 'kustomization.yaml.j2'
    dest: "{{ awx_operator_src_dir }}/kustomization.yaml"
    owner: "{{ awx_kubectl_user }}"
    group: "{{ awx_kubectl_user }}"
    mode: '0744'
  become: true
  tags:
    - awx
    - awx.operator

- name: Create awx custom resource def
  ansible.builtin.template:
    src: 'awx-crd.yaml.j2'
    dest: "{{ awx_operator_src_dir }}/awx-crd.yaml"
    owner: "{{ awx_kubectl_user }}"
    group: "{{ awx_kubectl_user }}"
    mode: '0744'
  become: true
  tags:
    - awx
    - awx.operator

- name: Install awx operator
  ansible.builtin.shell: /opt/awx_operator/kustomize build . | kubectl apply -f -
  args:
    chdir: "{{ awx_operator_src_dir }}"
  become: true
  become_user: "{{ awx_kubectl_user }}"
  register: operator_install
  changed_when: "'created' in operator_install.stdout"
  tags:
    - awx
    - awx.operator
    - molecule-idempotence-notest

- name: Add awx config file to kustomize crd conf file
  ansible.builtin.lineinfile:
    dest: "{{ awx_operator_src_dir }}/kustomization.yaml"
    insertafter: "  # Awx CRD"
    line: '  - awx-crd.yaml'
  become: true
  tags:
    - awx
    - awx.operator
    - molecule-idempotence-notest

- name: Install awx
  ansible.builtin.shell: /opt/awx_operator/kustomize build . | kubectl apply -f -
  args:
    chdir: "{{ awx_operator_src_dir }}"
  become: true
  become_user: "{{ awx_kubectl_user }}"
  register: operator_install
  changed_when: "'created' in operator_install.stdout"
  tags:
    - awx
    - awx.operator
    - molecule-idempotence-notest
...
